<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortAI V2 (Live Feed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .page {
            display: none; /* ëª¨ë“  í˜ì´ì§€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-bubble {
            border-radius: 20px;
            padding: 12px 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        .stock-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 10px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a0a0e0;
        }

        /* ì‹¤ì‹œê°„ ë¼ì´ë¸Œ í”¼ë“œ ìŠ¤íƒ€ì¼ */
        #liveFeedContainer {
            overflow: hidden;
            position: relative;
        }
        .live-feed-item {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            /* ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ìƒíƒœ */
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s ease-out, background-color 0.2s ease;
        }
        .live-feed-item:hover {
            background-color: #e9f2ff;
            border-color: #007bff;
        }
        /* ì• ë‹ˆë©”ì´ì…˜ í™œì„±í™” í´ë˜ìŠ¤ (JSì—ì„œ ì‚¬ìš©) */
        .live-feed-item.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg">

        <!-- === 1. ë©”ì¸ í˜ì´ì§€ (V2: Live Feed Concept) === -->
        <div id="mainPage" class="page flex flex-col h-screen">
            <header class="flex-shrink-0 p-4">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-blue-600">PortAI</h1>
                    <button id="goToProButton" class="text-sm bg-gray-800 text-white py-2 px-4 rounded-full font-semibold hover:bg-gray-700 transition">
                        Pro ì „ëµìƒì„± ğŸ¤–
                    </button>
                </div>

                <div class="mb-4 text-center">
                    <p class="text-lg font-semibold text-gray-800">AIê°€ 9,000+ê°œ ë°ì´í„°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                    <p class="text-gray-600">ì–´ë–¤ íˆ¬ì ì „ëµì„ ì°¾ìœ¼ì‹œë‚˜ìš”?</p>
                </div>

                <div class="relative">
                    <input id="mainSearchInput" type="text" class="w-full border border-gray-300 rounded-full py-3 px-5 text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ: ìš”ì¦˜ ì˜ë‚˜ê°€ëŠ” ë°˜ë„ì²´">
                    <button id="mainSearchButton" class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                </div>
            </header>

            <!-- 'ì˜¤ëŠ˜ì˜ AI ì‹œí™© ë¸Œë¦¬í•‘' (Google ë¬¸êµ¬ ì œê±°ë¨) -->
            <div class="flex-shrink-0 p-4 pt-2">
                <div id="todayBriefingCard" 
                     class="p-5 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-all transform hover:-translate-y-1 prompt-feed-item"
                     data-prompt="ì˜¤ëŠ˜ì˜ AI ì‹œí™© ë¸Œë¦¬í•‘ (ì‹¤ì‹œê°„ ê²€ìƒ‰)">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">âš¡ï¸ ì˜¤ëŠ˜ì˜ AI ì‹œí™© ë¸Œë¦¬í•‘ (Live)</h3>
                        <span class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">HOT</span>
                    </div>
                    <p class="text-blue-100 text-sm">AIê°€ ì‹¤ì‹œê°„ ê²€ìƒ‰ìœ¼ë¡œ ìµœì‹  ì‹œí™©ê³¼ ì£¼ìš” íŠ¹ì§•ì£¼ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                    <button class="mt-3 text-sm font-semibold text-blue-700 bg-white py-2 px-4 rounded-full hover:bg-gray-100">
                        í´ë¦­í•˜ì—¬ ì§€ê¸ˆ ë¶„ì„í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- "ì§€ê¸ˆ ëœ¨ëŠ” í”„ë¡¬í”„íŠ¸" (ì‹¤ì‹œê°„ ìœ ì…) -->
            <div class="flex-grow overflow-hidden px-4">
                
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <h2 class="text-xl font-bold text-gray-900">ğŸ’¡ ì§€ê¸ˆ ëœ¨ëŠ” í”„ë¡¬í”„íŠ¸</h2>
                        <div class="flex items-center ml-3">
                            <span class="flex h-3 w-3 relative">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                            <span class="ml-2 text-xs font-semibold text-red-600">LIVE</span>
                        </div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ ìœ ì… í”¼ë“œ -->
                <div id="liveFeedContainer" class="space-y-3">
                    <!-- JSë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>

        <!-- === 2. ì‹œê·¸ë„ ìƒì„¸ í˜ì´ì§€ (V2ì—ì„œëŠ” ë©”ì¸ì—ì„œ ì§„ì…ì ì´ ì—†ìŒ) === -->
        <div id="signalPage" class="page p-4">
            <header class="flex items-center mb-4">
                <button id="backToMainFromSignal" class="text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 id="signalStrategyName" class="text-xl font-bold text-center flex-grow">ì „ëµ ìƒì„¸</h2>
            </header>
            
            <div class="mb-4">
                <h3 class="text-lg font-bold mb-2 text-gray-900">ëˆ„ì  ìˆ˜ìµë¥  (ë°±í…ŒìŠ¤íŠ¸)</h3>
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                    <canvas id="strategyChart"></canvas>
                </div>
            </div>
            <div class="mb-4">
                <h3 class="text-lg font-bold mb-2 text-gray-900">í•µì‹¬ ì„±ê³¼</h3>
                <div id="perfMetrics" class="grid grid-cols-3 gap-3 bg-white border border-gray-200 rounded-lg p-4 shadow-sm"></div>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm">
                <h3 class="text-lg font-semibold mb-1">ì „ëµ ì„¤ëª…</h3>
                <p id="signalStrategyDesc" class="text-gray-700 text-sm"></p>
            </div>
            <h3 class="text-lg font-bold mb-3 text-gray-900">ì˜¤ëŠ˜ì˜ ì‹œê·¸ë„ (2025-11-11)</h3>
            <ul class="space-y-3">
                <li class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold">OOì „ì (005930)</h4>
                        <span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">ğŸŸ¢ ì‹ ê·œ ë§¤ìˆ˜</span>
                    </div>
                    <p class="text-gray-600 mb-3">AI ëª¨ë©˜í…€ ì ìˆ˜ 9.2/10, ê¸°ê´€ ì—°ì† ìˆœë§¤ìˆ˜ í¬ì°©</p>
                    <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
                        (ì¦ê¶Œì‚¬) ë§¤ìˆ˜í•˜ê¸° â†—ï¸
                    </button>
                </li>
            </ul>
        </div>

        <!-- === 3. AI ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ (Track 1.5) === -->
        <div id="chatResultPage" class="page flex flex-col h-screen">
            <header class="flex items-center p-4 bg-white border-b border-gray-200 shadow-sm">
                <button id="backToMainFromChat" class="text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-xl font-bold text-center flex-grow">AI ì „ëµ ë¶„ì„</h2>
            </header>
            
            <div id="chatResultContainer" class="flex-grow p-4 space-y-4 overflow-y-auto chat-container" style="background-color: #f8f9fa;">
                <!-- ë™ì ìœ¼ë¡œ ì±„íŒ… ë²„ë¸” ì¶”ê°€ -->
            </div>

            <footer class="p-4 bg-white border-t border-gray-200">
                <div class="flex space-x-2">
                    <input id="chatResultInput" type="text" class="w-full border border-gray-300 rounded-full py-3 px-5 text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="chatResultSend" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                </div>
            </footer>
        </div>

        <!-- === 4. Pro ì „ëµ ìƒì„± í˜ì´ì§€ (Track 2) === -->
        <div id="proPage" class="page flex flex-col h-screen">
            <header class="flex items-center p-4 bg-white border-b border-gray-200 shadow-sm">
                <button id="backToMainFromPro" class="text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-xl font-bold text-center flex-grow">ğŸ¤– Pro ì „ëµ ìƒì„±</h2>
            </header>

            <div id="proChatContainer" class="flex-grow p-4 space-y-4 overflow-y-auto chat-container" style="background-color: #f8f9fa;">
                <div class="chat-bubble chat-bubble-ai">
                    ì•ˆë…•í•˜ì„¸ìš”! ğŸ¤– PortAIì…ë‹ˆë‹¤.<br>
                    ì–´ë–¤ ì „ëµì„ ë§Œë“¤ì–´ ë³¼ê¹Œìš”?<br><br>
                    (ì˜ˆì‹œ: PER 10 ì´í•˜, PBR 1 ì´í•˜ì´ê³ , ìµœê·¼ 1ê°œì›”ê°„ ê¸°ê´€ì´ 100ì–µ ì´ìƒ ìˆœë§¤ìˆ˜í•œ ì¢…ëª©ì„ ì°¾ì•„ì¤˜.)
                </div>
            </div>

            <footer class="p-4 bg-white border-t border-gray-200">
                <div class="flex space-x-2">
                    <input id="proChatInput" type="text" class="w-full border border-gray-300 rounded-full py-3 px-5 text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì „ëµì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="proChatSend" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <!-- 
    ===============================================================
    SCRIPT (ì˜¤ë¥˜ ìˆ˜ì •ì„ ìœ„í•´ ëª¨ë“  ë¡œì§ì„ DOMContentLoadedë¡œ ê°ìŒˆ)
    ===============================================================
    -->
    <script type="module">
        // [ìˆ˜ì •] ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ DOMContentLoadedë¡œ ê°ì‹¸
        // 'í•˜ì–€ í™”ë©´' (ë¡œë“œ ì˜¤ë¥˜)ì„ ê·¼ë³¸ì ìœ¼ë¡œ í•´ê²°
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. ìƒìˆ˜ ë° ë³€ìˆ˜ ì •ì˜ ===
            const API_KEY = "";
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const GOOGLE_SEARCH_TOOL = { "google_search": {} };
            let currentChart = null; 

            // === 2. DOM ìš”ì†Œ ì¡°íšŒ ===
            // (DOMì´ ë¡œë“œëœ í›„ì— ì‹¤í–‰ë˜ë¯€ë¡œ ì•ˆì „)
            const pages = {
                main: document.getElementById('mainPage'),
                signal: document.getElementById('signalPage'),
                chatResult: document.getElementById('chatResultPage'),
                pro: document.getElementById('proPage')
            };

            const mainSearchInput = document.getElementById('mainSearchInput');
            const chatResultContainer = document.getElementById('chatResultContainer');
            const chatResultInput = document.getElementById('chatResultInput');
            const proChatContainer = document.getElementById('proChatContainer');
            const proChatInput = document.getElementById('proChatInput');
            const liveFeedContainer = document.getElementById('liveFeedContainer');

            // === 3. í•µì‹¬ í•¨ìˆ˜ ì •ì˜ ===

            /**
             * í˜ì´ì§€ë¥¼ ì „í™˜í•˜ëŠ” í•¨ìˆ˜
             * @param {string} pageKey - 'main', 'signal', 'chatResult', 'pro'
             */
            function showPage(pageKey) {
                console.log(`Showing page: ${pageKey}`);
                Object.values(pages).forEach(page => {
                    if (page) page.style.display = 'none';
                });
                const pageToShow = pages[pageKey];
                if (pageToShow) {
                    // 'display: block' ëŒ€ì‹  'display: flex'ê°€ í•„ìš”í•œ í˜ì´ì§€ ì²˜ë¦¬
                    if (pageKey === 'chatResult' || pageKey === 'pro' || pageKey === 'main') {
                        pageToShow.style.display = 'flex';
                    } else {
                        pageToShow.style.display = 'block';
                    }
                } else {
                    console.error(`Page not found for key: ${pageKey}`);
                }
            }

            /**
             * (V1ìš©) ì‹œê·¸ë„ ìƒì„¸ í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜
             */
            function showSignalPage(data) {
                // (V2ì—ì„œëŠ” ë©”ì¸ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ê¸°ëŠ¥ì€ ìœ ì§€)
                document.getElementById('signalStrategyName').textContent = data.name;
                document.getElementById('signalStrategyDesc').textContent = data.desc;
                const perfMetricsEl = document.getElementById('perfMetrics');
                if (perfMetricsEl) {
                    perfMetricsEl.innerHTML = `... (ì„±ê³¼ í‘œì‹œ) ...`;
                }
                showPage('signal');
                // (ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì½”ë“œ ...)
            }

            /**
             * Gemini API í˜¸ì¶œ (ëª©ì—…)
             * @param {string} prompt - ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸
             * @param {boolean} useGoogleSearch - ì‹¤ì‹œê°„ ê²€ìƒ‰ ì‚¬ìš© ì—¬ë¶€
             */
            async function callGemini(prompt, useGoogleSearch = false) {
                console.log(`Calling Gemini API (Search=${useGoogleSearch}):`, prompt);
                
                // --- ëª©ì—… ì‘ë‹µ (API í‚¤ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡) ---
                return new Promise(resolve => {
                    setTimeout(() => {
                        let response = `ì£„ì†¡í•©ë‹ˆë‹¤. ì§€ê¸ˆì€ ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (API í‚¤ í•„ìš”)`;
                        if (useGoogleSearch) {
                             response = `**[ì˜¤ëŠ˜ì˜ AI ì‹œí™© ë¸Œë¦¬í•‘ (Live)]**
                             <br>
                             (ì‹¤ì‹œê°„ ê²€ìƒ‰ ê¸°ë°˜ ì •ë³´)
                             <br><br>
                             - **KOSPI:** 2,850.5 (+1.2%)
                             - **ì£¼ìš” íŠ¹ì§•:** AI ë° ë°˜ë„ì²´ ì„¹í„°ê°€ ì‹¤ì‹œê°„ ë‰´ìŠ¤ë¡œ ì¸í•´ ê°•ì„¸ë¥¼ ë³´ì´ë©° ì§€ìˆ˜ ìƒìŠ¹ì„ ê²¬ì¸í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ OOì „ìì™€ XXí•˜ì´ë‹‰ìŠ¤ì˜ HBM ê´€ë ¨ì£¼ê°€ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤.
                             - **ì˜¤ëŠ˜ì˜ íŠ¹ì§•ì£¼:** OOì „ì, XXí•˜ì´ë‹‰ìŠ¤, â–³â–³ë°˜ë„ì²´`;
                        } else if (prompt.includes("ë°˜ë„ì²´") || prompt.includes("HBM")) {
                             response = `HBM ë° AI ì¹© ê´€ë ¨ ë¶„ì„ì…ë‹ˆë‹¤. ...`;
                        } else if (prompt.includes("PER") && prompt.includes("PBR")) {
                             response = `ìš”ì²­í•˜ì‹  [PER 10 ì´í•˜, PBR 1 ì´í•˜] ì¡°ê±´ìœ¼ë¡œ ì „ëµì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ...`;
                        } else {
                            response = `"${prompt}"ì— ëŒ€í•œ ë¶„ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ...`;
                        }
                        resolve(response);
                    }, 1500);
                });
            }

            /**
             * Gemini API ë¶„ì„ í˜¸ì¶œ (ëª©ì—…)
             */
            async function callGeminiForAnalysis(prompt) {
                console.log("Calling Gemini API (Analysis):", prompt);
                // --- ëª©ì—… ì‘ë‹µ ---
                return new Promise(resolve => {
                    setTimeout(() => {
                        let response = `ì£„ì†¡í•©ë‹ˆë‹¤. ì§€ê¸ˆì€ ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (API í‚¤ í•„ìš”)`;
                        if (prompt.includes("ì„ ì • ì´ìœ ")) {
                            response = `AIê°€ í•´ë‹¹ ì¢…ëª©ë“¤ì„ ì„ ì •í•œ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
                            1.  **OOì „ì:** HBM3E ì‹œì¥ ì„ ë„...
                            2.  **XXí•˜ì´ë‹‰ìŠ¤:** ì•ˆì •ì ì¸ HBM ìˆ˜ìœ¨...
                            3.  **â–³â–³ë°˜ë„ì²´:** ì°¨ì„¸ëŒ€ íŒ¨í‚¤ì§• ê¸°ìˆ ...`;
                        } else if (prompt.includes("ì‹œí™©")) {
                            response = `AIê°€ ì‹¤ì‹œê°„ ê²€ìƒ‰ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜¤ëŠ˜ ì‹œí™©ì„ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ... (ì´í•˜ ë¶„ì„ ë‚´ìš©)`;
                        } else {
                             response = `"${prompt}"ì— ëŒ€í•œ ë¶„ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.`;
                        }
                        resolve(response);
                    }, 1000);
                });
            }

            /**
             * ì±„íŒ… ë©”ì‹œì§€ UIì— ì¶”ê°€
             */
            function addChatMessage(container, message, sender) {
                if (!container) return;
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai');
                if (sender === 'ai-loading') {
                    bubble.id = 'ai-loading-bubble';
                    bubble.classList.remove('chat-bubble-ai');
                    bubble.innerHTML = '<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div></div>';
                } else {
                    bubble.innerHTML = message.replace(/\n/g, '<br>');
                }
                container.appendChild(bubble);
                container.scrollTop = container.scrollHeight;
            }

            /**
             * ë¡œë”© ì¸ë””ì¼€ì´í„° ì œê±°
             */
            function removeLoadingIndicator() {
                const loadingBubble = document.getElementById('ai-loading-bubble');
                if (loadingBubble) {
                    loadingBubble.remove();
                }
            }
            
            /**
             * V2ìš© 'ì‹¤ì‹œê°„ ë¼ì´ë¸Œ í”¼ë“œ' ì‹œì‘ í•¨ìˆ˜
             */
            function startLiveFeed() {
                if (!liveFeedContainer) return;

                const prompts = [
                    "PER 10 ì´í•˜, PBR 1 ì´í•˜ì¸ ì €í‰ê°€ ê°€ì¹˜ì£¼ ì°¾ì•„ì¤˜",
                    "HBM ê´€ë ¨ì£¼ ì¤‘ì— ëª¨ë©˜í…€ì´ ê°€ì¥ ê°•í•œ ì¢…ëª©ì€?",
                    "ì•ˆì •ì ì¸ ë°°ë‹¹ì£¼ í¬íŠ¸í´ë¦¬ì˜¤ 5ì¢…ëª© ì¶”ì²œ",
                    "RSI 30 ì´í•˜ ê³¼ë§¤ë„ êµ¬ê°„ ì¢…ëª©",
                    "ìµœê·¼ 1ì£¼ì¼ê°„ ê¸°ê´€ ìˆœë§¤ìˆ˜ ìƒìœ„ 10ì¢…ëª©",
                    "2ì°¨ì „ì§€ ê´€ë ¨ì£¼ ìµœê·¼ ë‰´ìŠ¤ ìš”ì•½í•´ì¤˜",
                    "ì˜¤ëŠ˜ ì™¸êµ­ì¸ê³¼ ê¸°ê´€ì´ ë™ì‹œì— ìˆœë§¤ìˆ˜í•œ ì¢…ëª©",
                    "MACD ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒí•œ ì½”ìŠ¤ë‹¥ ì¢…ëª©"
                ];
                let promptIndex = 0;

                setInterval(() => {
                    // 1. ìƒˆ í”¼ë“œ ì•„ì´í…œ ìƒì„±
                    const feedItem = document.createElement('div');
                    feedItem.className = 'live-feed-item prompt-feed-item p-4 rounded-lg cursor-pointer transition-all duration-300';
                    const currentPrompt = prompts[promptIndex];
                    feedItem.dataset.prompt = currentPrompt;
                    
                    feedItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800 truncate pr-4">${currentPrompt}</p>
                            <span class="text-xs text-blue-500 font-medium flex-shrink-0">ë°©ê¸ˆ ì „</span>
                        </div>
                    `;
                    
                    // 2. í´ë¦­ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    feedItem.addEventListener('click', () => {
                        mainSearchInput.value = currentPrompt;
                        handleMainSearch();
                    });

                    // 3. ëª©ë¡ ìµœìƒë‹¨ì— ì‚½ì…
                    liveFeedContainer.prepend(feedItem);
                    
                    // 4. ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±° (ì¤‘ìš”)
                    // (requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì €ê°€ ìš”ì†Œë¥¼ ì¸ì§€í•œ í›„ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€)
                    requestAnimationFrame(() => {
                        feedItem.classList.add('show');
                    });

                    // 5. 5ê°œê°€ ë„˜ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ í•­ëª© ì œê±°
                    if (liveFeedContainer.children.length > 5) {
                        const oldItem = liveFeedContainer.lastElementChild;
                        oldItem.classList.remove('show'); // ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜
                        oldItem.style.opacity = '0';
                        oldItem.addEventListener('transitionend', () => {
                            oldItem.remove();
                        });
                    }

                    // 6. ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                    promptIndex = (promptIndex + 1) % prompts.length;
                    
                }, 3000); // 3ì´ˆë§ˆë‹¤
            }

            /**
             * ë©”ì¸ ê²€ìƒ‰ì°½ í•¸ë“¤ëŸ¬ (V2)
             */
            async function handleMainSearch() {
                const query = mainSearchInput.value.trim();
                if (query === "") return;

                showPage('chatResult');
                chatResultContainer.innerHTML = ''; // ì±„íŒ…ì°½ ì´ˆê¸°í™”
                addChatMessage(chatResultContainer, query, 'user');
                addChatMessage(chatResultContainer, '...loading...', 'ai-loading');
                
                // [ìˆ˜ì •ë¨] 'ì‹œí™© ë¸Œë¦¬í•‘' í”„ë¡¬í”„íŠ¸ ë¶„ê¸° ì²˜ë¦¬ (ì‹¤ì‹œê°„ ê²€ìƒ‰ ì‚¬ìš©)
                if (query.includes("ì‹œí™© ë¸Œë¦¬í•‘")) {
                    const briefingResponse = await callGemini(query, true); // <--- useGoogleSearch = true
                    removeLoadingIndicator();
                    addChatMessage(chatResultContainer, briefingResponse, 'ai');
                    
                    addChatMessage(chatResultContainer, '...loading...', 'ai-loading');
                    const analysisPrompt = `ìœ„ ì‹œí™© ê¸°ë°˜ ì¶”ì²œ ì¢…ëª© 2ê°œ ì„ ì • ì´ìœ  ë¶„ì„`;
                    const analysisResult = await callGeminiForAnalysis(analysisPrompt); 
                    removeLoadingIndicator();
                    addChatMessage(chatResultContainer, analysisResult, 'ai');

                } else {
                    // (ê¸°ì¡´ì˜) ëª©ì—… ì¢…ëª© ì¹´ë“œ
                    await new Promise(r => setTimeout(r, 500));
                    removeLoadingIndicator();
                    const stockCardsHTML = `
                        <p class="text-sm text-gray-700 mb-2">AIê°€ "${query}" ê´€ë ¨ ì¢…ëª© 2ê°œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
                        <div class="stock-card">
                            <h4 class="text-lg font-semibold">OOì „ì (005930)</h4>
                            <p class="text-gray-600 text-sm mt-1">AI ì¹©, HBM3E ì‹œì¥ ì„ ë„</p>
                            <button class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition text-sm">
                                (ì¦ê¶Œì‚¬) ë§¤ìˆ˜í•˜ê¸° â†—ï¸
                            </button>
                        </div>
                        <div class="stock-card">
                            <h4 class="text-lg font-semibold">XXí•˜ì´ë‹‰ìŠ¤ (000660)</h4>
                            <p class="text-gray-600 text-sm mt-1">ì•ˆì •ì ì¸ HBM ìˆ˜ìœ¨ í™•ë³´</p>
                            <button class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition text-sm">
                                (ì¦ê¶Œì‚¬) ë§¤ìˆ˜í•˜ê¸° â†—ï¸
                            </button>
                        </div>
                    `;
                    addChatMessage(chatResultContainer, stockCardsHTML);

                    // AI ë¶„ì„ ì´ìœ 
                    addChatMessage(chatResultContainer, '...loading...', 'ai-loading');
                    const analysisPrompt = `ìœ„ ì¢…ëª© 2ê°œë¥¼ ì„ ì •í•œ ì´ìœ ë¥¼ ìì„¸íˆ ë¶„ì„í•´ì¤˜.`;
                    const analysisResult = await callGeminiForAnalysis(analysisPrompt);
                    removeLoadingIndicator();
                    addChatMessage(chatResultContainer, analysisResult, 'ai');
                }
                
                mainSearchInput.value = ""; // ê²€ìƒ‰ í›„ ë©”ì¸ ê²€ìƒ‰ì°½ ë¹„ìš°ê¸°
            }

            /**
             * Pro ì±„íŒ… í•¸ë“¤ëŸ¬
             */
            async function handleProChatSend() {
                const query = proChatInput.value.trim();
                if (query === "") return;
                addChatMessage(proChatContainer, query, 'user');
                proChatInput.value = "";
                addChatMessage(proChatContainer, '...loading...', 'ai-loading');
                const response = await callGemini(query, false); // ProëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ê²€ìƒ‰ ë¯¸ì‚¬ìš©
                removeLoadingIndicator();
                addChatMessage(proChatContainer, response, 'ai');
            }

            /**
             * AI ê²€ìƒ‰ ê²°ê³¼ (ì¶”ê°€ ì§ˆë¬¸) í•¸ë“¤ëŸ¬
             */
            async function handleChatResultSend() {
                const query = chatResultInput.value.trim();
                if (query === "") return;
                addChatMessage(chatResultContainer, query, 'user');
                chatResultInput.value = "";
                addChatMessage(chatResultContainer, '...loading...', 'ai-loading');
                const response = await callGemini(query, false); // ì¶”ê°€ ì§ˆë¬¸ì€ ê¸°ë³¸ì ìœ¼ë¡œ ê²€ìƒ‰ ë¯¸ì‚¬ìš©
                removeLoadingIndicator();
                addChatMessage(proChatContainer, response, 'ai');
            }

            /**
             * === 4. ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ===
             * [FIX] ëª¨ë“  ID ì¡°íšŒ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì˜µì…”ë„ ì²´ì´ë‹(?.
)ì„ ì¶”ê°€í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
             */
            function setupEventListeners() {
                document.getElementById('goToProButton')?.addEventListener('click', () => showPage('pro'));

                // 'ì˜¤ëŠ˜ì˜ AI ì‹œí™© ë¸Œë¦¬í•‘' ë°°ë„ˆ í´ë¦­
                document.getElementById('todayBriefingCard')?.addEventListener('click', () => {
                    const prompt = document.getElementById('todayBriefingCard').dataset.prompt;
                    mainSearchInput.value = prompt;
                    handleMainSearch();
                });

                // (ë¼ì´ë¸Œ í”¼ë“œ í•­ëª© í´ë¦­ì€ startLiveFeed í•¨ìˆ˜ ë‚´ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë  ë•Œë§ˆë‹¤ ì¶”ê°€ë¨)

                // í˜ì´ì§€ ì´ë™ ë²„íŠ¼ë“¤
                document.getElementById('backToMainFromSignal')?.addEventListener('click', () => showPage('main'));
                document.getElementById('backToMainFromPro')?.addEventListener('click', () => showPage('main'));
                document.getElementById('backToMainFromChat')?.addEventListener('click', () => showPage('main'));

                // ì±„íŒ… ì…ë ¥ í•¸ë“¤ëŸ¬
                document.getElementById('proChatSend')?.addEventListener('click', handleProChatSend);
                proChatInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleProChatSend();
                });
                document.getElementById('chatResultSend')?.addEventListener('click', handleChatResultSend);
                chatResultInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleChatResultSend();
                });

                // ë©”ì¸ ê²€ìƒ‰ì°½ í•¸ë“¤l
                document.getElementById('mainSearchButton')?.addEventListener('click', handleMainSearch);
                mainSearchInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleMainSearch();
                });
            }
            
            // === 5. ì•± ì´ˆê¸° ì‹¤í–‰ ===
            setupEventListeners();
            showPage('main'); // ì´ˆê¸° í˜ì´ì§€ ì„¤ì •
            startLiveFeed(); // ë¼ì´ë¸Œ í”¼ë“œ ì‹œì‘

        }); // [ìˆ˜ì •] DOMContentLoaded ë˜í¼ ì¢…ë£Œ

    </script>
</body>
</html>